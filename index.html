<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Globo da Rede ‚Äì Visual Presenter</title>

<!-- Depend√™ncias -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/globe.gl@2.32.3/dist/globe.gl.min.js"></script>

<style>
  html, body { height:100%; margin:0; background:#000; overflow:hidden; font-family:Segoe UI,Roboto,sans-serif; color:#fff; }
  #layout { display:flex; height:100vh; width:100vw; }
  aside {
    width:320px; background:#111c2b; border-right:1px solid #22334a;
    padding:12px; overflow:auto; z-index:1; position:relative;
  }
  #globe { flex:1; position:relative; overflow:hidden; z-index:0; }
  #globe canvas { position:absolute; top:0; left:0; width:100% !important; height:100% !important; }
  h1{margin:0 0 10px;font-size:18px;color:#00e5ff}
  h2{margin-top:14px;font-size:16px;color:#9ddcff}
  .btn{padding:6px 10px;margin:4px 0;border:1px solid #22334a;border-radius:6px;background:#1a283d;color:#fff;cursor:pointer;width:100%}
  .btn:hover{filter:brightness(1.2)}
  .btn-danger{background:#3a1a1a;border-color:#5c2a2a;color:#ffd6d6}
  ul{list-style:none;padding:0;margin:0}
  li{padding:6px;border-radius:6px;margin:2px 0;background:#1b2a3e;display:flex;justify-content:space-between;align-items:center}
  li span{cursor:pointer}
  input,select,textarea{margin:4px 0;padding:6px;width:100%;border-radius:6px;border:1px solid #22334a;background:#0b1625;color:#fff}
  .hint{font-size:12px;color:#9fb3d1;margin-top:4px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50}
  .modal.open{display:flex}
  .modal .box{background:#111c2b;border:1px solid #22334a;border-radius:8px;padding:12px;width:min(90vw,480px)}
</style>
</head>
<body>
  <div id="layout">
    <!-- Sidebar -->
    <aside>
      <h1>Rede Global ‚Ä¢ Demo</h1>
      <button id="btnSeed" class="btn">Carregar Exemplo</button>
      <button id="btnClear" class="btn btn-danger">Limpar</button>

      <h2>Adicionar Ponto</h2>
      <form id="pointForm">
        <input type="hidden" id="pointId">
        <input id="pointName" placeholder="Nome" required>
        <select id="pointType">
          <option value="torre">Torre</option>
          <option value="cliente">Cliente</option>
          <option value="pop">POP</option>
        </select>
        <!-- TEXT + inputmode para aceitar ponto ou v√≠rgula; tamb√©m aceita colar 'lat, lng' -->
        <input id="pointLat" type="text" inputmode="decimal" placeholder="Latitude (ex.: -17.248096 ou -17,248096)" required>
        <input id="pointLng" type="text" inputmode="decimal" placeholder="Longitude (ex.: -42.800431 ou -42,800431)" required>
        <div class="hint">Dica: voc√™ pode colar <b>‚Äú-17.248096, -42.800431‚Äù</b> no campo de Latitude que eu separo pra voc√™.</div>
        <textarea id="pointDesc" placeholder="Descri√ß√£o"></textarea>
        <input id="pointImgUrl" type="url" placeholder="URL da imagem (opcional)">
        <button type="submit" class="btn">Salvar</button>
      </form>

      <h2>Pontos</h2>
      <ul id="pointsList"></ul>

      <h2>Links</h2>
      <select id="arcStart"></select>
      <select id="arcEnd"></select>
      <input id="arcLabel" placeholder="R√≥tulo">
      <button id="btnAddArc" class="btn">Criar Link</button>
      <ul id="arcsList"></ul>
    </aside>

    <!-- Globo -->
    <main id="globe"></main>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="box">
      <h3 id="mTitle"></h3>
      <p id="mDesc"></p>
      <img id="mImg" src="" style="width:100%;border-radius:6px">
      <div>
        <button id="mClose" class="btn">Fechar</button>
      </div>
    </div>
  </div>

<script>
const LS_POINTS="globe_points_demo", LS_ARCS="globe_arcs_demo";
const pinColors={torre:"orange",cliente:"dodgerblue",pop:"limegreen"};
let points=JSON.parse(localStorage.getItem(LS_POINTS)||"[]");
let arcs=JSON.parse(localStorage.getItem(LS_ARCS)||"[]");

function save(){localStorage.setItem(LS_POINTS,JSON.stringify(points));localStorage.setItem(LS_ARCS,JSON.stringify(arcs));}
function uuid(){return crypto.randomUUID?crypto.randomUUID():Date.now()+"";}

/* ====== Parse de coordenadas robusto ====== */
function normalizeNumber(str){
  if (str == null) return NaN;
  let s = String(str).trim();
  if (!s) return NaN;
  // remove espa√ßos
  s = s.replace(/\s+/g,'');
  // se √© n√∫mero com v√≠rgula decimal e sem ponto -> troca v√≠rgula por ponto
  if (/^-?\d+,\d+$/.test(s)) s = s.replace(',', '.');
  return parseFloat(s);
}
function splitLatLngIfPastedTogether(latField, lngField){
  // Se o usu√°rio colou "lat, lng" no campo de latitude
  const raw = latField.value;
  if (raw.includes(',') && !lngField.value.trim()){
    const parts = raw.split(',');
    if (parts.length === 2){
      latField.value = parts[0].trim();
      lngField.value = parts[1].trim();
    }
  }
}

/* ====== Globo ====== */
const g=Globe()(document.getElementById("globe"))
  .globeImageUrl("//unpkg.com/three-globe/example/img/earth-dark.jpg")
  .bumpImageUrl("//unpkg.com/three-globe/example/img/earth-topology.png")
  .backgroundImageUrl("//unpkg.com/three-globe/example/img/night-sky.png")
  .pointAltitude(0.02).pointRadius(0.4)
  .pointColor(p=>pinColors[p.type]||"cyan")
  .onPointClick(p=>openModal(p));

g.controls().autoRotate=true;g.controls().autoRotateSpeed=0.6;

function fit(){const el=document.getElementById("globe");g.width(el.clientWidth);g.height(el.clientHeight);}
window.addEventListener("resize",fit);window.addEventListener("load",()=>setTimeout(fit,100));

function refresh(){g.pointsData(points);g.arcsData(arcs);}
refresh();

/* ====== UI ====== */
function renderPoints(){
  const list=document.getElementById("pointsList");
  list.innerHTML="";
  points.forEach(p=>{
    const li=document.createElement("li");
    li.innerHTML=`<span>${p.name}</span><button onclick="delPoint('${p.id}')">üóë</button>`;
    li.querySelector("span").onclick=()=>g.pointOfView({lat:p.lat,lng:p.lng,altitude:1.3},900);
    list.appendChild(li);
  });
}
function delPoint(id){points=points.filter(p=>p.id!==id);arcs=arcs.filter(a=>a.start!==id&&a.end!==id);save();renderPoints();renderArcs();refresh();}
function renderArcs(){
  const list=document.getElementById("arcsList");
  list.innerHTML="";
  arcs.forEach(a=>{
    const s=points.find(p=>p.id===a.start),e=points.find(p=>p.id===a.end);
    if(!s||!e)return;
    const li=document.createElement("li");li.textContent=a.label||`${s.name}‚Üî${e.name}`;
    list.appendChild(li);
  });
}
function populateArcSelectors(){
  const opts=points.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
  document.getElementById("arcStart").innerHTML=opts;
  document.getElementById("arcEnd").innerHTML=opts;
}

/* ====== Form de Ponto ====== */
document.getElementById("pointForm").onsubmit=e=>{
  e.preventDefault();
  const latInput=document.getElementById("pointLat");
  const lngInput=document.getElementById("pointLng");

  // Se colou "lat, lng" no campo de latitude, separa
  splitLatLngIfPastedTogether(latInput, lngInput);

  const lat = normalizeNumber(latInput.value);
  const lng = normalizeNumber(lngInput.value);

  if (Number.isNaN(lat) || Number.isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180){
    alert("Coordenadas inv√°lidas.\nExemplos v√°lidos:\n-17.248096, -42.800431\nou\n-17,248096 e -42,800431");
    return;
  }

  const p={
    id: document.getElementById("pointId").value || uuid(),
    name: document.getElementById("pointName").value.trim(),
    type: document.getElementById("pointType").value,
    lat, lng,
    description: document.getElementById("pointDesc").value.trim(),
    img: document.getElementById("pointImgUrl").value.trim()
  };

  points = points.filter(x=>x.id!==p.id).concat([p]);
  save(); renderPoints(); populateArcSelectors(); refresh();
  e.target.reset();

  // Foca no ponto rec√©m-criado
  g.pointOfView({lat:p.lat,lng:p.lng,altitude:1.3},900);
};

/* ====== Links ====== */
document.getElementById("btnAddArc").onclick=()=>{
  const s=document.getElementById("arcStart").value,e=document.getElementById("arcEnd").value;
  if(s&&e&&s!==e){arcs.push({id:uuid(),start:s,end:e,label:document.getElementById("arcLabel").value.trim()});save();renderArcs();refresh();}
};

/* ====== A√ß√µes r√°pidas ====== */
document.getElementById("btnSeed").onclick=()=>{
  points=[
    {id:uuid(),lat:-23.55,lng:-46.63,name:"POP S√£o Paulo",type:"pop",description:"SP"},
    {id:uuid(),lat:-22.90,lng:-43.17,name:"Torre Rio",type:"torre",description:"RJ"}
  ];
  arcs=[{id:uuid(),start:points[0].id,end:points[1].id,label:"SP-RJ"}];
  save();renderPoints();renderArcs();populateArcSelectors();refresh();
};
document.getElementById("btnClear").onclick=()=>{points=[];arcs=[];save();renderPoints();renderArcs();refresh();populateArcSelectors();};

/* ====== Modal ====== */
function openModal(p){
  document.getElementById("mTitle").textContent=p.name;
  document.getElementById("mDesc").textContent=p.description||"";
  document.getElementById("mImg").src=p.img||"https://placehold.co/600x400";
  document.getElementById("modal").classList.add("open");
}
document.getElementById("mClose").onclick=()=>document.getElementById("modal").classList.remove("open");

/* Inicial */
renderPoints();renderArcs();populateArcSelectors();refresh();fit();
</script>
</body>
</html>
